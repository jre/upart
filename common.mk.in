# -*-Makefile-*-
CC           = @CC@
CFLAGS       = @CFLAGS@ @CPPFLAGS@ @DEFS@
DEPFLAGS     = -MM
LDFLAGS      = @LDFLAGS@
LIBS         = @LIBS@
prefix       = @prefix@
exec_prefix  = @exec_prefix@
datarootdir  = @datarootdir@
sbindir      = @sbindir@
mandir       = @mandir@
INSTALL      = @INSTALL@
INSTALL_PROG = @INSTALL_PROGRAM@ -m 755
INSTALL_DATA = @INSTALL_DATA@
MKDIR_P      = @MKDIR_P@

ALL_PROGS     = upart
ALL_SRCS      = ${UPART_SRCS}
ALL_HDRS      = ${UPART_HDRSRC:=.h} bsdqueue.h
UPART_SRCS    = ${UPART_HDRSRC:=.c} main.c
UPART_HDRSRC  = apm bsdlabel crc32 disk gpt img interactive map mbr os \
		sunlabel-shared sunlabel-sparc sunlabel-x86 util
REGRESS_DIR   = regression-tests
REGRESS_CMD   = sh ./test.sh

UPART_OBJS    = ${UPART_SRCS:.c=.o}
ALL_OBJS      = ${ALL_SRCS:.c=.o}

.PHONY: all clean

all: ${ALL_PROGS}

install: all
	${MKDIR_P} ${DESTDIR}${sbindir}
	${INSTALL_PROG} upart ${DESTDIR}${sbindir}
	${MKDIR_P} ${DESTDIR}${mandir}/man8
	${INSTALL_DATA} upart.8 ${DESTDIR}${mandir}/man8

upart: ${UPART_OBJS}
	${CC} ${CFLAGS} ${LDFLAGS} ${LIBS} -o $@ ${UPART_OBJS}

.c.o:
	${CC} ${CFLAGS} -c -o $@ $<

clean: clean-tests
	rm -f .depend ${ALL_PROGS} ${ALL_OBJS}

clean-tests:
	cd ${REGRESS_DIR} && env UPART_TEST_CLEAN=y ${REGRESS_CMD}

cleaner: clean
	rm -f config.cache config.h config.log config.status

cleanest: cleaner
	rm -f configure

test tests regress regression: ${ALL_PROGS}
	cd ${REGRESS_DIR} && ${REGRESS_CMD}

regen-tests: ${ALL_PROGS}
	cd ${REGRESS_DIR} && env UPART_TEST_REGEN=y ${REGRESS_CMD}
